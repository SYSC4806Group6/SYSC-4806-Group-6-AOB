<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <!-- Expose CSRF token/header to client-side code -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>AmazinBookStore | Catalog</title>
    <link rel="stylesheet" href="/css/default-styles.css">
    <link rel="stylesheet" href="/css/book-styles.css">
</head>
<body>
<header>
    <a th:href="@{/admin/books}"
       sec:authorize="hasRole('ADMIN')"
       class="admin-button left-admin-button">
        Admin Panel
    </a>

    <h1 class="site-title">
        Amazin Book Catalog
        <span>by Group 6</span>
    </h1>
    <div class="header-controls">
        <form class="search-form" th:action="@{/books}" method="get">
            <input type="text"
                   name="searchTerm"
                   placeholder="Search by title, author, or publisher"
                   th:value="${criteria.searchTerm}">
            <button type="submit" class="search-button" aria-label="Search">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M15.5 14h-.79l-.28-.27a6 6 0 1 0-.91.91l.27.28v.79l4.25 4.24 1.49-1.49L15.5 14zm-6 0a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/>
                </svg>
            </button>
        </form>

        <a class="cart-button" th:href="@{/cart}">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7 4h-2l-1 2H2v2h1l3.6 7.59L5 18a2 2 0 1 0 2 2h10v-2H7.42l.93-2h7.45a2 2 0 0 0 1.87-1.31L21 6H6.42l-.94-2zM7 20a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm10 0a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm1.1-6h-8.45l-2.1-4.5h12.3L18.1 14z"/>
            </svg>
            <span class="cart-count" id="cart-count" th:text="${cartSize}">0</span>
        </a>
        <a class="header-receipts" th:href="@{/purchaseReceipts}">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M17 4H9c-2 0-3 1.5-3 3v10c0 1.5 1 3 3 3h8c1.5 0 2-1 2-2V6c0-1-.5-2-2-2zm-8 5h7m-7 4h7m-7 4h7"/>
            </svg>
        </a>

        <div class="auth-controls">
            <div sec:authorize="!isAuthenticated()">
                <a th:href="@{/login}">Login</a>
            </div>

            <div sec:authorize="isAuthenticated()">
                <span sec:authentication="name">Username</span>
                <form th:action="@{/logout}" method="post">
                    <button type="submit">Logout</button>
                </form>
            </div>
        </div>
    </div>
</header>

<div id="cart-banner" class="cart-banner hidden"></div>

<div class="catalog-layout">
    <aside class="filters-panel">
        <form th:action="@{/books}" method="get">
            <input type="hidden" name="searchTerm" th:value="${criteria.searchTerm}">
            <input type="hidden" name="size" th:value="${page.size}">

            <div class="filter-group open" data-filter-group>
                <button type="button" class="filter-toggle">
                    Publisher
                    <span class="chevron">⌄</span>
                </button>
                <div class="filter-body">
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="radio" name="publisher" value=""
                                   th:checked="${!criteria.hasPublisher()}">
                            <span class="checkbox-box"></span>
                            <span>All Publishers</span>
                        </label>
                        <label class="filter-option"
                               th:each="publisher : ${publishers}">
                            <input type="radio" name="publisher"
                                   th:value="${publisher}"
                                   th:checked="${criteria.publisher != null ? #strings.equalsIgnoreCase(publisher, criteria.publisher) : false}">
                            <span class="checkbox-box"></span>
                            <span th:text="${publisher}">Publisher</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="filter-group" data-filter-group>
                <button type="button" class="filter-toggle">
                    Tag
                    <span class="chevron">⌄</span>
                </button>
                <div class="filter-body">
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="radio" name="tag" value=""
                                   th:checked="${!criteria.hasTag()}">
                            <span class="checkbox-box"></span>
                            <span>All Tags</span>
                        </label>
                        <label class="filter-option"
                               th:each="tagItem : ${tags}">
                            <input type="radio" name="tag"
                                   th:value="${tagItem}"
                                   th:checked="${criteria.tag != null ? #strings.equalsIgnoreCase(tagItem, criteria.tag) : false}">
                            <span class="checkbox-box"></span>
                            <span th:text="${tagItem}">Tag</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="filter-group" data-filter-group>
                <button type="button" class="filter-toggle">
                    Sort by
                    <span class="chevron">⌄</span>
                </button>
                <div class="filter-body">
                    <div class="filter-options">
                        <label class="filter-option"
                               th:each="sortOption : ${sortOptions}">
                            <input type="radio" name="sortBy"
                                   th:value="${sortOption}"
                                   th:checked="${criteria.sortBy != null ? sortOption.equalsIgnoreCase(criteria.sortBy) : sortOption == 'title'}">
                            <span class="checkbox-box"></span>
                            <span th:text="${#strings.capitalize(sortOption)}">Sort</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="filter-group" data-filter-group>
                <button type="button" class="filter-toggle">
                    Direction
                    <span class="chevron">⌄</span>
                </button>
                <div class="filter-body">
                    <div class="filter-options">
                        <label class="filter-option"
                               th:each="direction : ${directions}">
                            <input type="radio" name="sortDirection"
                                   th:value="${direction.name()}"
                                   th:checked="${criteria.sortDirection != null ? direction == criteria.sortDirection : direction.name() == 'ASC'}">
                            <span class="checkbox-box"></span>
                            <span th:text="${direction.name()}">Direction</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit">Apply Filters</button>
            </div>
        </form>
    </aside>

    <div class="catalog-content">
        <div th:if="${errorMessage}" class="alert" th:text="${errorMessage}"></div>

        <section th:if="${#lists.isEmpty(books)}">
            <p>No books found. Try adjusting your search or filters.</p>
        </section>

        <section class="book-grid"
                 th:if="${!#lists.isEmpty(books)}"
                 th:classappend="${newCatalogLayout} ? ' list-layout' : ' grid-layout'">
            <article class="book-card"
                     th:each="book : ${books}"
                     th:attr="data-href=@{/books/{isbn}(isbn=${book.isbn})}"
                     role="link"
                     tabindex="0">
                <div class="card-media">
                    <img th:if="${book.pictureUrl != null}" th:src="${book.pictureUrl}" th:alt="${book.title}">
                    <div th:if="${book.pictureUrl == null}" class="no-image">
                        <span>No image</span>
                    </div>
                </div>
                <div class="book-info">
                    <h2 th:text="${book.title}">Book Title</h2>
                    <p><strong>Author:</strong> <span th:text="${book.author}">Author Name</span></p>

                    <div class="book-extra">
                        <p><strong>Publisher:</strong> <span th:text="${book.publisher}">Publisher</span></p>
                        <p th:if="${book.description}" th:text="${#strings.abbreviate(book.description, 120)}"></p>
                        <p th:if="${!#lists.isEmpty(book.tags)}">
                            <strong>Tags:</strong>
                            <span th:each="tag : ${book.tags}" th:text="${tag}" style="margin-right:0.5rem;"></span>
                        </p>
                    </div>

                    <div class="card-actions">
                        <span class="price-pill"
                              th:text="${'$' + #numbers.formatDecimal(book.price, 1, 'COMMA', 2, 'POINT')}">
                            $0.00
                        </span>
                        <div th:if="${showAddToCart}">
                            <form class="add-to-cart-form" th:attr="data-isbn=${book.isbn}">
                                <button type="submit" class="add-to-cart-btn">
                                    <span>Add to Cart</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </article>
        </section>

        <nav class="pagination" th:if="${page.totalPages > 1}">
            <span th:if="${page.isFirst()}">First</span>
            <a th:if="${!page.isFirst()}"
               th:href="@{/books(page=0, size=${page.size}, searchTerm=${criteria.searchTerm}, publisher=${criteria.publisher}, tag=${criteria.tag}, sortBy=${criteria.sortBy}, sortDirection=${criteria.sortDirection != null ? criteria.sortDirection.name() : 'ASC'})}">
                First
            </a>
            <span th:if="${!page.hasPrevious()}">Prev</span>
            <a th:if="${page.hasPrevious()}"
               th:href="@{/books(page=${page.number - 1}, size=${page.size}, searchTerm=${criteria.searchTerm}, publisher=${criteria.publisher}, tag=${criteria.tag}, sortBy=${criteria.sortBy}, sortDirection=${criteria.sortDirection != null ? criteria.sortDirection.name() : 'ASC'})}">
                Prev
            </a>
            <span th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
                  th:if="${page.totalPages <= 7 or (i >= page.number - 2 && i <= page.number + 2)}">
                <span th:if="${i == page.number}"
                      th:text="${i + 1}"
                      class="active"></span>
                <a th:if="${i != page.number}"
                   th:text="${i + 1}"
                   th:href="@{/books(page=${i}, size=${page.size}, searchTerm=${criteria.searchTerm}, publisher=${criteria.publisher}, tag=${criteria.tag}, sortBy=${criteria.sortBy}, sortDirection=${criteria.sortDirection != null ? criteria.sortDirection.name() : 'ASC'})}"></a>
            </span>
            <span th:if="${!page.hasNext()}">Next</span>
            <a th:if="${page.hasNext()}"
               th:href="@{/books(page=${page.number + 1}, size=${page.size}, searchTerm=${criteria.searchTerm}, publisher=${criteria.publisher}, tag=${criteria.tag}, sortBy=${criteria.sortBy}, sortDirection=${criteria.sortDirection != null ? criteria.sortDirection.name() : 'ASC'})}">
                Next
            </a>
            <span th:if="${page.isLast()}">Last</span>
            <a th:if="${!page.isLast()}"
               th:href="@{/books(page=${page.totalPages - 1}, size=${page.size}, searchTerm=${criteria.searchTerm}, publisher=${criteria.publisher}, tag=${criteria.tag}, sortBy=${criteria.sortBy}, sortDirection=${criteria.sortDirection != null ? criteria.sortDirection.name() : 'ASC'})}">
                Last
            </a>
        </nav>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const filterGroups = document.querySelectorAll("[data-filter-group]");
        filterGroups.forEach(group => {
            const toggle = group.querySelector(".filter-toggle");
            const body = group.querySelector(".filter-body");

            const updateState = () => {
                const isOpen = group.classList.contains("open");
                toggle.setAttribute("aria-expanded", isOpen);
                if (isOpen) {
                    body.style.maxHeight = body.scrollHeight + "px";
                } else {
                    body.style.maxHeight = null;
                }
            };

            updateState();

            toggle.addEventListener("click", () => {
                group.classList.toggle("open");
                updateState();
            });
        });

        window.addEventListener("resize", () => {
            document.querySelectorAll("[data-filter-group].open .filter-body")
                .forEach(body => body.style.maxHeight = body.scrollHeight + "px");
        });

        document.querySelectorAll(".book-card").forEach(card => {
            const navigate = () => {
                const href = card.getAttribute("data-href");
                if (href) {
                    window.location.href = href;
                }
            };
            card.addEventListener("click", event => {
                if (event.target.closest("form")) {
                    return;
                }
                navigate();
            });
            card.addEventListener("keypress", event => {
                if ((event.key === "Enter" || event.key === " ") && !event.target.closest("form")) {
                    event.preventDefault();
                    navigate();
                }
            });
        });

        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

        document.querySelectorAll(".add-to-cart-form").forEach(form => {
            form.addEventListener("click", event => event.stopPropagation());

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                const isbn = this.getAttribute("data-isbn");

                const headers = {
                    'Content-Type': 'application/json'
                };
                if (csrfTokenMeta && csrfHeaderMeta) {
                    headers[csrfHeaderMeta.getAttribute('content')] = csrfTokenMeta.getAttribute('content');
                }

                fetch(`/cart/add/${isbn}`, {
                    method: "POST",
                    headers: headers
                })
                    .then(response => {
                        if (response.status === 403) {
                            window.location.href = '/login';
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.itemCount) {
                            document.getElementById("cart-count").innerText = data.itemCount;
                        }
                        if (data.added == false) {
                            const banner = document.getElementById("cart-banner");
                            banner.innerText = "No more copies of this book left in stock.";

                            banner.classList.remove("hidden");
                            banner.classList.add("show");

                            setTimeout(() => {
                                banner.classList.remove("show");
                            }, 3000);
                        }
                    })
                    .catch(error => console.error("Error adding to cart:", error));
            });
        });
    });
</script>
</body>
</html>
